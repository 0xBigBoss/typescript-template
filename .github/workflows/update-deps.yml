name: Update Dependencies

on:
  schedule:
    - cron: '0 6 * * 1' # Monday 6am UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: oven-sh/setup-bun@v2

      - name: Update .node-version to latest LTS
        run: |
          LATEST_LTS=$(curl -s https://nodejs.org/dist/index.json | \
            jq -r '[.[] | select(.lts != false)] | first | .version' | \
            sed 's/^v//')
          echo "$LATEST_LTS" > .node-version

      - name: Update npm packages
        run: bun update

      - name: Update Nix flake inputs
        run: nix flake update

      - name: Install and verify
        run: |
          bun install
          bun run check

      - name: Build
        run: bun run build

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$(cat <<'EOF'
          chore: weekly dependency updates
          EOF
          )"
            git push
          fi
